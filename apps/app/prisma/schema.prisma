generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String        @id @default(cuid())
  email     String        @unique
  role      String        @default("user")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  sessions  QuizSession[]

  @@map("users")
}

model QuizSession {
  id                    String                @id @default(cuid())
  userId                String?
  startedAt             DateTime              @default(now())
  completedAt           DateTime?
  status                String                @default("in_progress")
  durationMs            Int?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  quizType              String?               @default("financial-profile")
  affiliateCode         String?               @map("affiliate_code")
  affiliate_conversions AffiliateConversion[]
  articleViews          ArticleView[]
  answers               QuizAnswer[]
  user                  User?                 @relation(fields: [userId], references: [id])
  result                Result?

  @@index([affiliateCode, createdAt])
  @@index([affiliateCode, status, createdAt])
  @@map("quiz_sessions")
}

model QuizQuestion {
  id                  String           @id @default(cuid())
  order               Int
  prompt              String
  type                String
  options             Json
  active              Boolean          @default(true)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  quizType            String?          @default("financial-profile")
  showContinueButton  Boolean          @default(false)
  continueButtonText  String           @default("Continue")
  continueButtonColor String           @default("#09727c")
  showSkipOption      Boolean          @default(false)
  skipOptionText      String           @default("Skip")
  skipButton          Boolean          @default(false)
  continueButton      Boolean          @default(false)
  textUnderAnswers    String?
  textUnderButton     String?
  triggers            ArticleTrigger[]
  loadingScreens      LoadingScreen[]
  answers             QuizAnswer[]

  @@map("quiz_questions")
}

model QuizAnswer {
  id         String       @id @default(cuid())
  sessionId  String
  questionId String
  value      Json
  dwellMs    Int?
  createdAt  DateTime     @default(now())
  question   QuizQuestion @relation(fields: [questionId], references: [id])
  session    QuizSession  @relation(fields: [sessionId], references: [id])

  @@map("quiz_answers")
}

model Result {
  id        String      @id @default(cuid())
  sessionId String      @unique
  archetype String
  scores    Json
  createdAt DateTime    @default(now())
  session   QuizSession @relation(fields: [sessionId], references: [id])

  @@map("results")
}

model Article {
  id                 String           @id @default(cuid())
  title              String
  content            String
  type               String
  category           String
  tags               Json
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  subtitle           String?
  personalizedText   String?
  backgroundColor    String?          @default("#ffffff")
  textColor          String?          @default("#000000")
  iconColor          String?          @default("#3b82f6")
  accentColor        String?          @default("#ef4444")
  iconType           String?          @default("document")
  showIcon           Boolean?         @default(true)
  showStatistic      Boolean?         @default(true)
  statisticText      String?
  statisticValue     String?
  ctaText            String?          @default("CONTINUE")
  showCta            Boolean?         @default(true)
  textAlignment      String?          @default("center")
  contentPosition    String?          @default("center")
  backgroundStyle    String?          @default("solid")
  backgroundGradient String?
  contentPadding     String?          @default("normal")
  showTopBar         Boolean?         @default(true)
  topBarColor        String?          @default("#1f2937")
  titleFontSize      String?          @default("large")
  titleFontWeight    String?          @default("bold")
  contentFontSize    String?          @default("normal")
  contentFontWeight  String?          @default("normal")
  lineHeight         String?          @default("normal")
  showCustomImage    Boolean          @default(false)
  customImageUrl     String?
  customImageAlt     String?
  imageUrl           String?
  imageAlt           String?
  showImage          Boolean          @default(false)
  triggers           ArticleTrigger[]
  views              ArticleView[]

  @@map("articles")
}

model ArticleTrigger {
  id          String        @id @default(cuid())
  articleId   String
  questionId  String?
  optionValue String?
  condition   Json
  priority    Int           @default(0)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  article     Article       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  question    QuizQuestion? @relation(fields: [questionId], references: [id])

  @@map("article_triggers")
}

model ArticleTemplate {
  id        String   @id @default(cuid())
  name      String
  template  String
  variables Json
  category  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("article_templates")
}

model ArticleView {
  id        String      @id @default(cuid())
  sessionId String
  articleId String
  viewedAt  DateTime    @default(now())
  article   Article     @relation(fields: [articleId], references: [id])
  session   QuizSession @relation(fields: [sessionId], references: [id])

  @@unique([sessionId, articleId])
  @@map("article_views")
}

model LoadingScreen {
  id                   String        @id @default(cuid())
  quizType             String
  title                String
  subtitle             String?
  personalizedText     String?
  duration             Int           @default(3000)
  iconType             String        @default("puzzle-4")
  animationStyle       String        @default("complete-rotate")
  backgroundColor      String        @default("#ffffff")
  textColor            String        @default("#000000")
  iconColor            String        @default("#3b82f6")
  progressBarColor     String        @default("#ef4444")
  showProgressBar      Boolean       @default(true)
  progressText         String?
  triggerQuestionId    String?
  isActive             Boolean       @default(true)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @default(now()) @updatedAt
  showTopBar           Boolean       @default(true)
  topBarColor          String        @default("#1f2937")
  loadingTexts         Json?         @db.Json
  contentPosition      String        @default("center")
  showCustomImage      Boolean       @default(false)
  customImageUrl       String?
  customImageAlt       String?
  imageUrl             String?
  imageAlt             String?
  showImage            Boolean       @default(false)
  progressBarFillColor String?       @default("#fb513d")
  progressBarBgColor   String?       @default("#e4dece")
  progressBarTextColor String?       @default("#191717")
  question             QuizQuestion? @relation(fields: [triggerQuestionId], references: [id])

  @@index([quizType])
  @@index([triggerQuestionId])
  @@map("loading_screens")
}

model Affiliate {
  id                   String                @id @default(cuid())
  name                 String
  email                String                @unique
  passwordHash         String                @map("password_hash")
  tier                 AffiliateTier         @default(quiz)
  referralCode         String                @unique @map("referral_code")
  customLink           String                @map("custom_link")
  payoutMethod         PayoutMethod?         @map("payout_method")
  payoutDetails        Json?                 @map("payout_details")
  commissionRate       Decimal               @default(0.1000) @map("commission_rate") @db.Decimal(5, 4)
  totalClicks          Int                   @default(0) @map("total_clicks")
  totalLeads           Int                   @default(0) @map("total_leads")
  totalBookings        Int                   @default(0) @map("total_bookings")
  totalSales           Int                   @default(0) @map("total_sales")
  totalCommission      Decimal               @default(0.00) @map("total_commission") @db.Decimal(10, 2)
  isActive             Boolean               @default(true) @map("is_active")
  isApproved           Boolean               @default(false) @map("is_approved")
  stripeAccountId      String?               @map("stripe_account_id")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  custom_tracking_link String?
  auditLogs            AffiliateAuditLog[]
  clicks               AffiliateClick[]
  conversions          AffiliateConversion[]
  payouts              AffiliatePayout[]

  @@index([isApproved, isActive])
  @@index([createdAt])
  @@map("affiliates")
}

model AffiliateClick {
  id           String    @id @default(cuid())
  affiliateId  String    @map("affiliate_id")
  referralCode String    @map("referral_code")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  landing_page String?
  utmSource    String?   @map("utm_source")
  utmMedium    String?   @map("utm_medium")
  utmCampaign  String?   @map("utm_campaign")
  createdAt    DateTime  @default(now()) @map("created_at")
  affiliate    Affiliate @relation(fields: [affiliateId], references: [id])

  @@index([affiliateId, createdAt])
  @@index([createdAt])
  @@index([referralCode, createdAt])
  @@index([affiliateId])
  @@index([referralCode])
  @@map("affiliate_clicks")
}

model NormalWebsiteClick {
  id        String   @id @default(cuid())
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@map("normal_website_clicks")
}

model AffiliateConversion {
  id               String            @id @default(cuid())
  affiliateId      String            @map("affiliate_id")
  quizSessionId    String?           @map("quiz_session_id")
  referralCode     String            @map("referral_code")
  conversionType   String            @map("conversion_type")
  status           ConversionStatus  @default(pending)
  commissionAmount Decimal           @default(0.00) @map("commission_amount") @db.Decimal(10, 2)
  saleValue        Decimal           @default(0.00) @map("sale_value") @db.Decimal(10, 2)
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  commissionStatus CommissionStatus? @default(held) @map("commission_status")
  holdUntil        DateTime?         @map("hold_until") @db.Timestamp(6)
  releasedAt       DateTime?         @map("released_at") @db.Timestamp(6)
  affiliate        Affiliate         @relation(fields: [affiliateId], references: [id])
  quiz_sessions    QuizSession?      @relation(fields: [quizSessionId], references: [id])

  @@index([affiliateId])
  @@index([commissionStatus, holdUntil])
  @@index([createdAt])
  @@index([referralCode, createdAt])
  @@index([affiliateId, commissionStatus, createdAt], map: "affiliate_conversions_affiliate_id_commission_status_idx")
  @@index([quizSessionId])
  @@map("affiliate_conversions")
}

model AffiliatePayout {
  id               String       @id @default(dbgenerated("(gen_random_uuid())::text"))
  affiliateId      String       @map("affiliate_id")
  amountDue        Decimal      @map("amount_due") @db.Decimal(10, 2)
  status           payoutstatus @default(pending)
  paidAt           DateTime?    @map("paid_at") @db.Timestamptz(6)
  stripeTransferId String?      @map("stripe_transfer_id")
  notes            String?
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  affiliate        Affiliate    @relation(fields: [affiliateId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([affiliateId], map: "idx_affiliate_payouts_affiliate_id")
  @@index([createdAt], map: "idx_affiliate_payouts_created_at")
  @@index([status], map: "idx_affiliate_payouts_status")
  @@map("affiliate_payouts")
}

model AffiliateAuditLog {
  id          String    @id @default(cuid())
  affiliateId String    @map("affiliate_id")
  action      String
  details     Json?
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id])

  @@index([affiliateId])
  @@index([action], map: "idx_affiliate_audit_logs_action")
  @@index([affiliateId], map: "idx_affiliate_audit_logs_affiliate_id")
  @@index([createdAt], map: "idx_affiliate_audit_logs_created_at")
  @@map("affiliate_audit_logs")
}

model Closer {
  id                String                   @id @default(dbgenerated("(gen_random_uuid())::text"))
  name              String
  email             String                   @unique
  passwordHash      String                   @map("password_hash")
  phone             String?
  isActive          Boolean?                 @default(true) @map("is_active")
  isApproved        Boolean?                 @default(false) @map("is_approved")
  commissionRate    Decimal?                 @default(0.1500) @map("commission_rate") @db.Decimal(5, 4)
  totalCalls        Int?                     @default(0) @map("total_calls")
  totalConversions  Int?                     @default(0) @map("total_conversions")
  totalRevenue      Decimal?                 @default(0.00) @map("total_revenue") @db.Decimal(10, 2)
  conversionRate    Decimal?                 @default(0.00) @map("conversion_rate") @db.Decimal(5, 4)
  createdAt         DateTime?                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime?                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  calendlyLink      String?                  @map("calendly_link")
  appointments      Appointment[]
  auditLogs         CloserAuditLog[]
  scriptAssignments CloserScriptAssignment[]
  tasks             Task[]

  @@index([email], map: "idx_closers_email")
  @@index([isActive], map: "idx_closers_is_active")
  @@index([isApproved], map: "idx_closers_is_approved")
  @@map("closers")
}

model Appointment {
  id                             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  closerId                       String?   @map("closer_id")
  calendlyEventId                String    @unique @map("calendly_event_id")
  customerName                   String    @map("customer_name")
  customerEmail                  String    @map("customer_email")
  customerPhone                  String?   @map("customer_phone")
  scheduledAt                    DateTime  @map("scheduled_at") @db.Timestamptz(6)
  duration                       Int?      @default(30)
  status                         String?   @default("scheduled")
  outcome                        String?
  notes                          String?
  saleValue                      Decimal?  @map("sale_value") @db.Decimal(10, 2)
  commissionAmount               Decimal?  @map("commission_amount") @db.Decimal(10, 2)
  affiliateCode                  String?   @map("affiliate_code")
  utmSource                      String?   @map("utm_source")
  utmMedium                      String?   @map("utm_medium")
  utmCampaign                    String?   @map("utm_campaign")
  createdAt                      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  recordingLink                  String?   @map("recording_link")
  recordingLinkConverted         String?   @map("recording_link_converted")
  recordingLinkNotInterested     String?   @map("recording_link_not_interested")
  recordingLinkNeedsFollowUp     String?   @map("recording_link_needs_follow_up")
  recordingLinkWrongNumber       String?   @map("recording_link_wrong_number")
  recordingLinkNoAnswer          String?   @map("recording_link_no_answer")
  recordingLinkCallbackRequested String?   @map("recording_link_callback_requested")
  recordingLinkRescheduled       String?   @map("recording_link_rescheduled")
  closer                         Closer?   @relation(fields: [closerId], references: [id], onUpdate: NoAction)
  tasks                          Task[]

  @@index([closerId, outcome])
  @@index([affiliateCode])
  @@index([scheduledAt])
  @@index([outcome])
  @@index([createdAt])
  @@index([affiliateCode, scheduledAt])
  @@index([affiliateCode, status, scheduledAt])
  @@index([calendlyEventId], map: "idx_appointments_calendly_event_id")
  @@index([closerId], map: "idx_appointments_closer_id")
  @@index([scheduledAt], map: "idx_appointments_scheduled_at")
  @@index([status], map: "idx_appointments_status")
  @@map("appointments")
}

model Task {
  id            String       @id @default(cuid())
  appointmentId String?      @map("appointment_id")
  leadEmail     String?      @map("lead_email")
  closerId      String       @map("closer_id")
  title         String
  description   String?
  priority      TaskPriority @default(medium)
  status        TaskStatus   @default(pending)
  dueDate       DateTime?    @map("due_date")
  completedAt   DateTime?    @map("completed_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  closer        Closer       @relation(fields: [closerId], references: [id], onDelete: SetNull)

  @@index([leadEmail, status])
  @@index([closerId, status])
  @@index([dueDate, status])
  @@map("tasks")
}

model Note {
  id            String   @id @default(cuid())
  leadEmail     String   @map("lead_email")
  content       String
  createdBy     String?  @map("created_by")
  createdByType String?  @map("created_by_type")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([leadEmail])
  @@index([createdAt])
  @@map("notes")
}

model CloserAuditLog {
  id        String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  closerId  String?   @map("closer_id")
  action    String
  details   Json?
  ipAddress String?   @map("ip_address")
  userAgent String?   @map("user_agent")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  closer    Closer?   @relation(fields: [closerId], references: [id], onUpdate: NoAction)

  @@index([closerId], map: "idx_closer_audit_logs_closer_id")
  @@index([createdAt], map: "idx_closer_audit_logs_created_at")
  @@map("closer_audit_logs")
}

model CloserScript {
  id             String                   @id @default(cuid())
  name           String
  callScript     String                   @map("call_script")
  programDetails Json?                    @map("program_details")
  emailTemplates Json?                    @map("email_templates")
  isDefault      Boolean                  @default(false) @map("is_default")
  isActive       Boolean                  @default(true) @map("is_active")
  createdAt      DateTime                 @default(now()) @map("created_at")
  updatedAt      DateTime                 @updatedAt @map("updated_at")
  assignments    CloserScriptAssignment[]

  @@map("closer_scripts")
}

model CloserScriptAssignment {
  id        String       @id @default(cuid())
  closerId  String       @map("closer_id")
  scriptId  String       @map("script_id")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  closer    Closer       @relation(fields: [closerId], references: [id], onDelete: Cascade)
  script    CloserScript @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@unique([closerId, scriptId])
  @@index([closerId])
  @@index([scriptId])
  @@map("closer_script_assignments")
}

model Settings {
  id        Int       @id @default(autoincrement())
  key       String    @unique @db.VarChar(255)
  value     String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)

  @@map("Settings")
}

enum AffiliateTier {
  quiz
  creator
  agency
}

enum PayoutMethod {
  stripe
  paypal
  wise
}

enum ConversionStatus {
  pending
  confirmed
  cancelled
}

enum CommissionStatus {
  held
  available
  paid
}

enum PayoutStatus {
  pending
  processing
  completed
  failed
}

enum AppointmentStatus {
  scheduled
  confirmed
  in_progress
  completed
  no_show
  cancelled
  rescheduled
}

enum CallOutcome {
  converted
  not_interested
  needs_follow_up
  wrong_number
  no_answer
  callback_requested
  rescheduled
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
}

enum payoutstatus {
  pending
  processing
  completed
  failed
}
